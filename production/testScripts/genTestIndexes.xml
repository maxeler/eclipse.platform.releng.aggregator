<project
  name="Helper targets"
  default="generateEclipseIndex"
  basedir=".">

  <target
    name="init"
    depends="initStreamVariables"
    unless="genTestIndexesInitialized">
    <fail unless="buildId" />
    <fail unless="eclipseStream" />
    <fail unless="job" />

    <property
      name="isBuildTested"
      value="true" />

    <script language="javascript">
      <![CDATA[
        var buildId = project.getProperty("buildId");
        var pattern = new RegExp(/^([IMXYPNSR])(\d{8})-(\d{4})$/);

        var sArray = pattern.exec(buildId);
        // sArray 0 is "whole match"
        project.setProperty("buildType", sArray[1]);
      ]]>
    </script>
    <condition
      property="dropsDirSegment"
      value="drops4"
      else="drops">
      <equals
        arg1="${eclipseStreamMajor}"
        arg2="4" />
    </condition>
    <!-- publish.xml expects buildLabel in places, instead of buildId,
         though we use them interchangebly -->
    <property
      name="buildLabel"
      value="${buildId}" />
    <property
      name="dropsDirXSegment"
      value="${dropsDirSegment}" />

    <property
      name="buildRoot"
      value="${buildHome}/${eclipseStreamMajor}${buildType}" />

    <property
      name="postingDirectory"
      value="${buildRoot}/siteDir/eclipse/downloads/${dropsDirXSegment}" />

    <condition
      property="hrefTestResultsTargetPath"
      value="baselineAlt">
      <contains
        string="${job}"
        substring="-baselineAlt" />
    </condition>
    <condition
      property="hrefTestResultsTargetPath"
      value="baseline">
      <contains
        string="${job}"
        substring="-baseline" />
    </condition>
    <condition
      property="hrefTestResultsTargetPath"
      value="."
      else="testresults">
      <contains
        string="${job}"
        substring="-perf-" />
    </condition>

    <condition
      property="testResultsHtmlFileName"
      value="baselineAlt.php">
      <contains
        string="${job}"
        substring="-baselineAlt" />
    </condition>
    <condition
      property="testResultsHtmlFileName"
      value="baseline.php">
      <contains
        string="${job}"
        substring="-baseline" />
    </condition>
    <condition
      property="testResultsHtmlFileName"
      value="performance/performance.php"
      else="testResults.php">
      <contains
        string="${job}"
        substring="-perf-" />
    </condition>

    <!-- Note: results template is selected based on
         conventions used in hudson jobs names. Should
         move to properties saved in during test run?
    -->
    <condition
      property="testTemplate"
      value="perfBaselineAltResults.php.template">
      <contains
        string="${job}"
        substring="-baselineAlt" />
    </condition>
    <condition
      property="testTemplate"
      value="perfBaselineResults.php.template">
      <contains
        string="${job}"
        substring="-baseline" />
    </condition>
    <condition
      property="testTemplate"
      value="performance.php.template"
      else="testResults.php.template">
      <contains
        string="${job}"
        substring="-perf-" />
    </condition>

    <condition
      property="testManifestFileName"
      value="${publishingContent}/performanceTestManifest.xml"
      else="${publishingContent}/testManifest.xml">
      <contains
        string="${job}"
        substring="-perf-" />
    </condition>

    <echo message="= = Properties in genTestIndexes.xml, init = = " />
    <echo message="    job: ${job}" />
    <echo message="    postingDirectory: ${postingDirectory}" />
    <echo message="    testTemplate: ${testTemplate}" />
    <echo message="    testManifestFileName: ${testManifestFileName}" />
    <echo message="    hrefTestResultsTargetPath: ${hrefTestResultsTargetPath}" />
    <echo message="    testResultsHtmlFileName: ${testResultsHtmlFileName}" />
    <echo message="    isBuildTested: ${isBuildTested}" />




    <property
      name="EBuilderDir"
      value="${postingDirectory}/${buildId}/eclipse.platform.releng.aggregator/eclipse.platform.releng.tychoeclipsebuilder" />

        <!-- This is purely a subset of tychoeclipsebuilder files, copyied at build time, so part of
        the results output we are working on, so they will be the same once the tests are done, even if gitCache updated by anohter build,
        or a run from previous test results -->
        <!-- /data/shared/eclipse/builds/4N/master/gitCache/eclipse.platform.releng.aggregator/eclipse.platform.releng.tychoeclipsebuilder/eclipse/publishingFiles -->
    <property
      name="publishingContent"
      value="${EBuilderDir}/eclipse/publishingFiles" />

        <!-- This is our new, "safe for every test" location -->
    <property
      name="base.builder"
      value="${postingDirectory}/${buildId}/org.eclipse.releng.basebuilder" />



        <!-- Not sure this is the "working directory" expected. May impact ability
        to get/find "buildNotes"? Need to copy such "source" things at build time. -->
    <property
      name="buildDirectory"
      value="${postingDirectory}/${buildId}" />


    <property
      name="genTestIndexesInitialized"
      value="true" />


  </target>

  <target
    name="generateEclipseIndex"
    depends="init">

    <property
      name="generatorClass"
      value="org.eclipse.releng.generators.EclipseTestResultsGeneratorNoMail" />
<!-- to be removed
    <condition
      property="generatorClass"
      value="org.eclipse.releng.generators.EclipseTestResultsGeneratorNoMail">
      <equals
        arg1="${hudson}"
        arg2="true" />
    </condition>
    <property
      name="generatorClass"
      value="org.eclipse.releng.generators.EclipseTestResultsGenerator" />
-->
    <echo message="   DEBUG: generatorClass: ${generatorClass}" />
    <available
      classname="${generatorClass}"
      property="class"
      value="${generatorClass}" />

    <property
      name="genTestIndexesdropTokenList"
      value="%sdk%,%tests%,%example%,%rcpruntime%,%rcpsdk%,%deltapack%,%runtime%,%jdt%,%jdtsdk%,%jdtc%,%pde%,%pdesdk%,%cvs%,%cvssdk%,%swt%,%relengtools%" />


    <property
      name="dropTokenList"
      value="${genTestIndexesdroptTokenList}" />

    <property
      name="indexFileName"
      value="index.php" />

    <property
      name="testResultsTemplateFileName"
      value="${publishingContent}/templateFiles/${testTemplate}" />
    <property
      name="dropTemplateFileName"
      value="${publishingContent}/templateFiles/index.php.template" />

    <fail
      unless="testManifestFileName"
      message="testManifestFileName should have been defined, by now?" />
    <!-- to be removed
    <property
      name="testManifestFileName"
      value="${publishingContent}/testManifest.xml" />
    -->
    <antcall target="publishEclipseIndex">
    </antcall>

  </target>

  <target
    name="publishEclipseIndex"
    depends="init">


    <fail
      unless="buildType"
      message="buildType should have been defined by now" />

        <!--regenerate the index page with links to test results -->
    <ant
      antfile="${EBuilderDir}/eclipse/buildScripts/publish.xml"
      dir="${publishingContent}"
      target="generateIndex">

      <property
        name="dropTokenList"
        value="%sdk%,%tests%,%example%,%rcpruntime%,%rcpsdk%,%deltapack%,%runtime%,%jdt%,%jdtsdk%,%jdtc%,%pde%,%pdesdk%,%cvs%,%cvssdk%,%swt%,%relengtools%" />

      <property
        name="testResultsTemplateFileName"
        value="${publishingContent}/templateFiles/${testTemplate}" />

      <property
        name="indexFileName"
        value="index.php" />
      <property
        name="dropTemplateFileName"
        value="${publishingContent}/templateFiles/index.php.template" />
      <property
        name="testManifestFileName"
        value="${publishingContent}/testManifest.xml" />
    </ant>

  </target>

  <target name="initStreamVariables">

    <fail
      unless="eclipseStream"
      message="eclipseStream must be provided by caller" />
    <condition property="streamOK">
      <matches
        pattern="\d\.\d\.\d"
        string="${eclipseStream}" />
    </condition>
    <fail
      message="eclipseStream variable had unexpected format. Should be digit.digit.digit, but was ${eclipseStream}"
      unless="streamOK" />
    <script language="javascript">
          <![CDATA[
            var eclipseStream = project.getProperty("eclipseStream");
            var pattern = new
            RegExp(/(\d+)\.(\d+)\.(\d+)/);

            var sArray = pattern.exec(eclipseStream);
            // sArray[0] is "whole match"
            project.setProperty("eclipseStreamMajor", sArray[1]);
            project.setProperty("eclipseStreamMinor", sArray[2]);
            project.setProperty("eclipseStreamService", sArray[3]);
          ]]>
    </script>

  </target>

</project>
